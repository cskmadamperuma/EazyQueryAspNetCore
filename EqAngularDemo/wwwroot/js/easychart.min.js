(function(n){var t=window.EQ=window.EQ||{};t.view=t.view||{};n.widget("eqjs.EasyChart",{_dataTable:null,_dataView:null,_potentialLabelColumns:[],_potentialDataColumns:[],_labelColumn:null,_dataColumns:[],_settingsDiv:null,_ccHeader:"eqjs-chart-header",_ccMain:"eqjs-chart-main",_ccSettings:"eqjs-chart-settings",_ccContent:"eqjs-chart-content",_stateChangedCallback:null,_defaultChartType:10,_chartProvider:null,_chartTypes:null,options:{chartType:10},_tryInitChartProvider:function(){return typeof t.view.chartProvider=="undefined"?!1:(this._chartProvider==null&&(this._chartProvider=t.view.chartProvider),!0)},_setOption:function(n,t){return arguments.length==2?(n=="chartType"?this.options.chartType=t&&this._chartTypes.hasOwnProperty(t.toString())?t:this._defaultChartType:this.options[n]=t,this._render(),this):this.options[n]},_create:function(){},_clear:function(){this.element.html("")},draw:function(n,t,i){var r,u;if(this._tryInitChartProvider()&&(r=this,this._chartTypes=this._chartProvider.chartTypes,t=t||{dataColumns:[]},this._setOption("chartType",t.chartType||this.options.chartType),r._dataTable=n,r._stateChangedCallback=i,r._dataTable)){r._potentialLabelColumns=[];r._potentialDataColumns=[];var h=r._dataTable.getNumberOfColumns(),e,o,s=!1,f=[].concat(t.dataColumns);for(u=0;u<h;u++)if(e=r._dataTable.getColumnType(u),o=r._dataTable.getColumnLabel(u),e=="string")r._potentialLabelColumns.push({idx:u,label:o}),t.labelColumn==u&&(s=!0);else if(e=="number")for(r._potentialDataColumns.push({idx:u,label:o});f.indexOf(u)>=0;)f.splice(f.indexOf(u),1);r._potentialLabelColumns.length>0&&(r._labelColumn=s?t.labelColumn:r._potentialLabelColumns[0].idx);r._potentialDataColumns.length>0&&(r._dataColumns=t.dataColumns.length>0&&f.length==0?[].concat(t.dataColumns):[].concat(r._potentialDataColumns[0].idx));r._chartProvider.init(this._dataTable,this.options.chartType,this._labelColumn,this._dataColumns)}this.refresh()},refresh:function(){this._render()},resize:function(){this._render()},_render:function(){var t=this,u,i,r,f,e,o,s;if(this._clear(),u=n("<div><\/div>").addClass(t._ccHeader),i=n("<div><\/div>").addClass(t._ccMain),this._chartProvider!=null){r=n("<select><\/select>");for(f in this._chartTypes)e=this._chartTypes[f],o=n("<option />",{value:f,text:e.name}),o.appendTo(r);r.val(this.options.chartType);r.appendTo(u);r.change(function(){var i=n(this).val();t.options.chartType=parseInt(i);t._chartProvider.setType(t.options.chartType);t.refresh();t._onStateChanged()});this._settingsDiv=n("<div><\/div>").addClass(this._ccSettings).hide().appendTo(i);this._chartDiv=n("<div><\/div>").addClass(this._ccContent).hide();this._chartDiv=this._chartProvider.preparePlaceholder(this._chartDiv);this._chartDiv.appendTo(i).fadeIn(1e3);this._initSettingsDiv();this._dataTable!=null&&this._dataTable.getNumberOfRows()>0?(s=n("<div><\/div>").addClass("eqjs-chart-settings-icon").attr("title","Settings").appendTo(u),s.click(function(){t._toggleSettings()}),t._redrawTwice()):n("<div><\/div>").addClass("eqjs-chart-no-data").text("No Data").appendTo(i)}else n("<div><\/div>").addClass("eqjs-chart-no-data").text("Chart Provider is not defined").appendTo(i);this.element.append(u);this.element.append(i)},_toggleSettings:function(n){var t,i;this._chartDiv.is(":visible")?(t=this._chartDiv,i=this._settingsDiv):(t=this._settingsDiv,i=this._chartDiv);t.fadeToggle({duration:200,complete:function(){i.fadeToggle({duration:200,complete:n})}})},_initSettingsDiv:function(){var t=this,u,i,f,r;n("<div><\/div").text("SETTINGS").addClass(this._ccSettings+"-header").appendTo(this._settingsDiv);u=n("<div><\/div").addClass(this._ccSettings+"-single").appendTo(this._settingsDiv);n("<span><\/span>").text("Label column: ").css({display:"inline-block"}).appendTo(u);i=n("<select><\/select>").css({display:"inline-block"}).appendTo(u);this._potentialLabelColumns.forEach(function(t){var r=n("<option />",{value:t.idx,text:t.label});r.appendTo(i)});i.val(this._labelColumn);i.change(function(){t._labelColumn=parseInt(n(this).val());t._chartProvider.setLabelColumn(t._labelColumn);t._chartProvider.updateChartColumns();t._toggleSettings(function(){t.refresh();t._onStateChanged()})});f=n("<div><\/div").addClass(this._ccSettings+"-single").appendTo(this._settingsDiv);n("<span><\/span>").text("Data column: ").css({display:"inline-block"}).appendTo(f);r=n("<select><\/select>").css({display:"inline-block"}).appendTo(f);this._potentialDataColumns.forEach(function(t){var i=n("<option />",{value:t.idx,text:t.label});i.appendTo(r)});r.val(this._dataColumns[0]);r.change(function(){t._dataColumns[0]=parseInt(n(this).val());t._chartProvider.setDataColumns(t._dataColumns);t._chartProvider.updateChartColumns();t._toggleSettings(function(){t.refresh();t._onStateChanged()})})},redraw:function(){this._chartProvider.draw(this._chartDiv)},_redrawTwice:function(){var n=this;n.redraw();setTimeout(function(){n.redraw()},200)},_onStateChanged:function(){if(this._stateChangedCallback){var n={};n.chartType=this.options.chartType;n.labelColumn=this._labelColumn;n.dataColumns=[].concat(this._dataColumns);this._stateChangedCallback(n)}}})})(jQuery);